# 第 18 章: マージコンフリクトの解決

前章で、私たちはコンフリクトが発生したリポジトリの内部状態を探検しました。ワーキングディレクトリにはコンフリクトマーカーが挿入され、インデックスは 3 つのバージョンのファイルを保持する特殊な状態になっています。

この章では、この「マージ中」状態を解消し、マージを正常に完了させるための具体的な 3 ステップを学びます。

**コンフリクト解決の 3 ステップ**:
1.  **ファイルを編集する**: コンフリクトマーカーを削除し、ファイルを手動で望ましい最終形に編集する。
2.  **`git add` する**: 編集したファイルを `git add` して、「この内容でコンフリクトは解決済みです」と Git に伝える。
3.  **`git commit` する**: マージを完了させるためのマージコミットを作成する。

---
## 18.1 ステップ 1: ファイルを編集する

まずは、コンフリクトしているファイルを直接編集します。前章から引き続き `conflict-practice` ディレクトリで作業しましょう。
`greeting.txt` をエディタで開きます。

```
<<<<<<< HEAD
Hello, main!
=======
Hello, feature!
>>>>>>> feature
```
開発者の仕事は、このブロック全体を、最終的にあるべき姿に書き換えることです。選択肢はいくつか考えられます。
- `main` 側の変更 (`Hello, main!`) を採用する。
- `feature` 側の変更 (`Hello, feature!`) を採用する。
- 両方の良いとこ取りをする（例: `Hello, main and feature!`）。
- 全く新しい内容にする（例: `Hello, everyone!`）。

今回は、両方の挨拶を残す形にしてみましょう。コンフリクトマーカーを全て削除し、以下のようにファイルを編集して保存します。
```
Hello, main!
Hello, feature!
```
これで、ワーキングディレクトリのファイルは最終的な姿になりました。

---
## 18.2 ステップ 2: `git add` で解決を通知する

次に、この解決済みのファイルを `git add` します。
```bash
git add greeting.txt
```
「`add` はファイルをステージングするためのコマンドじゃないの？」と思うかもしれません。その通りです。そして、コンフリクト解決における `git add` は、非常に重要な内部的な役割を持っています。

**`git add` の内部動作 (コンフリクト時)**:
1.  ワーキングディレクトリにある解決済みのファイル (`greeting.txt`) から、新しい `blob` オブジェクトを作成する。
2.  インデックス内にある、コンフリクトしていたファイルのステージ 1, 2, 3 のエントリを**全て削除**する。
3.  代わりに、先ほど作成した新しい `blob` を指す、**ステージ 0** のエントリをインデックスに追加する。

`git add` を実行した後に `git ls-files --stage` でインデックスの状態を確認してみましょう。
```bash
git ls-files --stage
```
出力結果（例）:
```
100644 <new_blob_hash> 0	greeting.txt
```
ステージ 1, 2, 3 が消え、見慣れたステージ 0 のエントリだけに戻りました。これで、Git はコンフリクトが解決したと認識します。`git status` を見ても、「All conflicts fixed but you are still merging.」（全てのコンフリクトは解決しましたが、まだマージ中です）と表示されるはずです。

---
## 18.3 ステップ 3: `git commit` でマージを完了する

インデックスの状態が正常に戻ったので、あとは通常通りコミットするだけです。
```bash
git commit
```
`git merge` の時と同様にエディタが立ち上がり、コミットメッセージの編集を求められます。`.git/MERGE_MSG` に保存されていたデフォルトのメッセージが最初から入っています。そのまま保存してエディタを閉じれば、マージコミットが作成されます。

これで、コンフリクトの解決とマージの全工程が完了しました。
- `.git/MERGE_HEAD` や `.git/MERGE_MSG` といった一時ファイルは自動的に削除されます。
- `main` ブランチのポインタは、新しく作られたマージコミットを指します。
- `git log --oneline --graph` を見れば、分岐した歴史が綺麗に 1 つに統合されたことが確認できます。

---
## 18.4 便利なショートカット: `--ours` と `--theirs`

手動でファイルを編集する代わりに、「とにかくこちらのブランチの変更を正としたい」または「相手のブランチの変更を全面的に採用したい」というケースもよくあります。その場合、`git checkout` コマンドが便利です。

- **`git checkout --ours <file>`**:
  コンフリクトしたファイルについて、`--ours`（我々の）側の変更、つまり `HEAD` が指す現在のブランチ (`main`) のバージョンでワーキングディレクトリのファイルを上書きします。

- **`git checkout --theirs <file>`**:
  `--theirs`（彼らの）側の変更、つまりマージしようとしている相手のブランチ (`feature`) のバージョンでファイルを上書きします。

これらのコマンドを使った後も、変更をインデックスに反映させるための `git add <file>` と、マージを完了させる `git commit` は必要です。

---
**まとめ**

- コンフリクトの解決は、**「編集 -> `git add` -> `git commit`」** の 3 ステップで行う。
- **ファイル編集**: ワーキングディレクトリでコンフリクトマーカーを削除し、ファイルを最終的な形に整える。
- **`git add`**: 内部的にインデックスのステージ 1, 2, 3 を削除し、解決済みの内容をステージ 0 として登録することで、コンフリクト解決を Git に通知する。
- **`git commit`**: マージを完了させるためのマージコミットを作成する。
- `--ours` や `--theirs` オプションは、どちらか一方の変更を完全に採用する場合の便利なショートカットである。

次の章では、エディタや GUI ツールを使って、より視覚的にコンフリクトを解決する方法を見ていきます。

最後に実験用ディレクトリを削除しておきましょう。
```bash
cd ..
rm -rf conflict-practice
```
